<script type="text/javascript">
    RED.nodes.registerType('download file',{
        category: 'MDT Platform',
        color: '#C0DEED',
        defaults: {
            name: {value:""},
            mdtEndpoint: {value:""},
            reference: {value:""},
            downloadDir: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "download.png",
        label: function() {
            return this.name||"download file";
        },
        oneditprepare: function() {
            // 디렉토리 선택 버튼 이벤트
            $("#node-input-dirBrowse").click(function() {
                // 디렉토리 선택을 위한 안내 메시지
                alert("디렉토리 경로를 직접 입력하거나, 파일 선택 버튼을 사용하여 임시로 파일을 선택한 후 경로에서 파일명을 제거하세요.");
                $("#node-input-fileInput").click();
            });
            
            // 파일 선택 시 디렉토리 경로 설정
            $("#node-input-fileInput").change(function() {
                const file = this.files[0];
                if (file) {
                    // 파일의 전체 경로에서 디렉토리 부분만 추출
                    const filePath = file.name; // 브라우저에서는 전체 경로를 가져올 수 없음
                    
                    // 현재 입력된 경로가 있으면 디렉토리 부분을 유지
                    const currentPath = $("#node-input-downloadDir").val();
                    let directoryPath = "";
                    
                    if (currentPath && currentPath.includes('/')) {
                        // 기존 경로에서 디렉토리 부분 추출
                        const lastSlashIndex = currentPath.lastIndexOf('/');
                        directoryPath = currentPath.substring(0, lastSlashIndex + 1);
                    } else if (currentPath && currentPath.includes('\\')) {
                        // Windows 경로인 경우
                        const lastBackslashIndex = currentPath.lastIndexOf('\\');
                        directoryPath = currentPath.substring(0, lastBackslashIndex + 1);
                    } else {
                        // 기존 경로가 없으면 파일명만 사용 (실제로는 사용자가 수정해야 함)
                        directoryPath = "./";
                    }
                    
                    $("#node-input-downloadDir").val(directoryPath);
                }
            });
            
            // 다운로드 디렉토리 입력 필드에 도움말 추가
            $("#node-input-downloadDir").attr("title", "다운로드할 파일이 저장될 디렉토리 경로를 입력하세요. 예: /home/user/downloads/ 또는 C:\\Users\\user\\Downloads\\");
        }
    });
</script>

<script type="text/html" data-template-name="download file">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-mdtEndpoint"><i class="fa fa-globe"></i> MDTPlatform Endpoint</label>
        <input type="text" id="node-input-mdtEndpoint" placeholder="https://api.mdtplatform.com">
    </div>
    <div class="form-row">
        <label for="node-input-reference"><i class="fa fa-link"></i> Reference</label>
        <input type="text" id="node-input-reference" placeholder="reference-value" required>
    </div>
    <div class="form-row">
        <label for="node-input-downloadDir"><i class="fa fa-folder"></i> Download Directory</label>
        <input type="text" id="node-input-downloadDir" placeholder="다운로드할 파일이 저장될 디렉토리 경로를 입력하세요" style="width: 70%;">
        <button type="button" id="node-input-dirBrowse" style="width: 25%; margin-left: 5%;">디렉토리 선택</button>
        <input type="file" id="node-input-fileInput" style="display: none;">
    </div>
</script>

<script type="text/html" data-help-name="download file">
    <p>MDT Platform에서 파일을 다운로드하는 노드입니다.</p>
    
    <h3>설정</h3>
    <dl class="message-properties">
        <dt>MDTPlatform Endpoint <span class="property-type">string</span></dt>
        <dd>MDT Platform API 엔드포인트 URL. 환경 변수 MDT_ENDPOINT가 설정되어 있으면 자동으로 사용됩니다.</dd>
        
        <dt>Reference <span class="property-type">string</span> <span style="color: red;">필수</span></dt>
        <dd>다운로드할 파일의 참조 경로</dd>
        
        <dt>Download Directory <span class="property-type">string</span> <span style="color: red;">필수</span></dt>
        <dd>다운로드할 파일이 저장될 디렉토리 경로를 입력하거나 디렉토리 선택 버튼을 사용합니다. 
        디렉토리 선택 시 기존 경로의 디렉토리 부분을 유지합니다. 
        예: /home/user/downloads/ 또는 C:\Users\user\Downloads\</dd>
    </dl>
    
    <h3>출력</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>다운로드 결과 정보를 포함한 객체</dd>
        
        <dt class="optional">filePath <span class="property-type">string</span></dt>
        <dd>다운로드된 파일의 전체 경로</dd>
        
        <dt class="optional">fileName <span class="property-type">string</span></dt>
        <dd>다운로드된 파일의 이름</dd>
        
        <dt class="optional">fileSize <span class="property-type">number</span></dt>
        <dd>다운로드된 파일의 크기 (바이트)</dd>
    </dl>
</script> 