<script type="text/javascript">
    function renderVariableList(listId, hiddenId, variables) {
        const list = document.getElementById(listId);
        list.innerHTML = '';
        variables.forEach((v, idx) => {
            const li = document.createElement('li');
            
            // 입력 변수 목록인 경우 (name, spec, type)
            if (listId === 'node-input-inputVariables-list') {
                li.innerHTML =
                    `<input type='text' placeholder='이름' value='${v.name || ''}' style='width:100px;margin-right:5px;' onchange='updateVariableName("${listId}",${idx},this.value)'>` +
                    `<input type='text' placeholder='variable-spec' value='${v.spec || ''}' style='width:150px;margin-right:5px;' onchange='updateVariableSpec("${listId}",${idx},this.value)'>` +
                    `<select style='width:80px;margin-right:5px;' onchange='updateVariableType("${listId}",${idx},this.value)'>` +
                    `<option value='reference' ${(v.type === 'reference') ? 'selected' : ''}>reference</option>` +
                    `<option value='value' ${(v.type === 'value') ? 'selected' : ''}>value</option>` +
                    `<option value='element' ${(v.type === 'element') ? 'selected' : ''}>element</option>` +
                    `</select>` +
                    `<button type='button' onclick='removeVariable("${listId}",${idx})'>삭제</button>`;
            }
            // 출력 변수 목록인 경우 (name, reference)
            else {
                li.innerHTML =
                    `<input type='text' placeholder='이름' value='${v.name || ''}' style='width:100px;margin-right:5px;' onchange='updateVariableName("${listId}",${idx},this.value)'>` +
                    `<input type='text' placeholder='reference' value='${v.reference || ''}' style='width:150px;margin-right:5px;' onchange='updateVariableReference("${listId}",${idx},this.value)'>` +
                    `<button type='button' onclick='removeVariable("${listId}",${idx})'>삭제</button>`;
            }
            list.appendChild(li);
        });
        document.getElementById(hiddenId).value = JSON.stringify(variables);
    }

    function addInputVariable() {
        const hidden = document.getElementById('node-input-inputVariables');
        let arr = [];
        try { arr = JSON.parse(hidden.value); } catch(e) {}
        arr.push({name:'', spec:'', type:'value'});
        renderVariableList('node-input-inputVariables-list', 'node-input-inputVariables', arr);
    }
    function addOutputVariable() {
        const hidden = document.getElementById('node-input-outputVariables');
        let arr = [];
        try { arr = JSON.parse(hidden.value); } catch(e) {}
        arr.push({name:'', reference:''});
        renderVariableList('node-input-outputVariables-list', 'node-input-outputVariables', arr);
    }
    function removeVariable(listId, idx) {
        const hiddenId = listId === 'node-input-inputVariables-list' ? 'node-input-inputVariables' : 'node-input-outputVariables';
        let arr = [];
        try { arr = JSON.parse(document.getElementById(hiddenId).value); } catch(e) {}
        arr.splice(idx, 1);
        renderVariableList(listId, hiddenId, arr);
    }
    function updateVariableName(listId, idx, value) {
        const hiddenId = listId === 'node-input-inputVariables-list' ? 'node-input-inputVariables' : 'node-input-outputVariables';
        let arr = [];
        try { arr = JSON.parse(document.getElementById(hiddenId).value); } catch(e) {}
        arr[idx].name = value;
        renderVariableList(listId, hiddenId, arr);
    }
    function updateVariableSpec(listId, idx, value) {
        const hiddenId = listId === 'node-input-inputVariables-list' ? 'node-input-inputVariables' : 'node-input-outputVariables';
        let arr = [];
        try { arr = JSON.parse(document.getElementById(hiddenId).value); } catch(e) {}
        arr[idx].spec = value;
        renderVariableList(listId, hiddenId, arr);
    }
    function updateVariableType(listId, idx, value) {
        const hiddenId = listId === 'node-input-inputVariables-list' ? 'node-input-inputVariables' : 'node-input-outputVariables';
        let arr = [];
        try { arr = JSON.parse(document.getElementById(hiddenId).value); } catch(e) {}
        arr[idx].type = value;
        renderVariableList(listId, hiddenId, arr);
    }
    function updateVariableReference(listId, idx, value) {
        const hiddenId = listId === 'node-input-inputVariables-list' ? 'node-input-inputVariables' : 'node-input-outputVariables';
        let arr = [];
        try { arr = JSON.parse(document.getElementById(hiddenId).value); } catch(e) {}
        arr[idx].reference = value;
        renderVariableList(listId, hiddenId, arr);
    }

    // Node-RED 에디터에서 노드 편집 시 리스트 렌더링
    RED.nodes.registerType('task http',{
        category: 'MDT Platform',
        color: '#C0DEED',
        defaults: {
            name: {value:""},
            mdtEndpoint: {value:""},
            serverEndpoint: {value:""},
            operationId: {value:""},
            poll: {value:"1.0"},
            timeout: {value:undefined},
            inputVariables: {value:[]},
            outputVariables: {value:[]}
        },
        inputs:1,
        outputs:1,
        icon: "serial in.png",
        label: function() {
            return this.name||"task http";
        },
        oneditprepare: function() {
            // 입력 변수 목록 렌더링
            let inputVars = [];
            try { inputVars = JSON.parse($("#node-input-inputVariables").val() || '[]'); } catch(e) {}
            renderVariableList('node-input-inputVariables-list', 'node-input-inputVariables', inputVars);
            // 출력 변수 목록 렌더링
            let outputVars = [];
            try { outputVars = JSON.parse($("#node-input-outputVariables").val() || '[]'); } catch(e) {}
            renderVariableList('node-input-outputVariables-list', 'node-input-outputVariables', outputVars);
        }
    });
</script>

<script type="text/html" data-template-name="task http">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-mdtEndpoint"><i class="fa fa-globe"></i> MDTPlatform Endpoint</label>
        <input type="text" id="node-input-mdtEndpoint" placeholder="https://api.mdtplatform.com">
        <div class="form-tip">환경 변수 MDT_ENDPOINT가 설정되어 있으면 자동으로 사용됩니다.</div>
    </div>
    <div class="form-row">
        <label for="node-input-serverEndpoint"><i class="fa fa-server"></i> 연산서버 Endpoint <span style="color: red;">*</span></label>
        <input type="text" id="node-input-serverEndpoint" placeholder="http://server-endpoint" required>
    </div>
    <div class="form-row">
        <label for="node-input-operationId"><i class="fa fa-cogs"></i> 연산 식별자 <span style="color: red;">*</span></label>
        <input type="text" id="node-input-operationId" placeholder="operation-id" required>
    </div>
    <div class="form-row">
        <label for="node-input-poll"><i class="fa fa-clock-o"></i> Polling (초)</label>
        <input type="text" id="node-input-poll" placeholder="1.0">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-hourglass-end"></i> Timeout (초)</label>
        <input type="text" id="node-input-timeout" placeholder="null">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sign-in"></i> 입력변수 목록</label>
        <ol id="node-input-inputVariables-list" style="padding-left:20px;"></ol>
        <input type="hidden" id="node-input-inputVariables">
        <button type="button" onclick="addInputVariable()">추가</button>
    </div>
    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> 출력변수 목록</label>
        <ol id="node-input-outputVariables-list" style="padding-left:20px;"></ol>
        <input type="hidden" id="node-input-outputVariables">
        <button type="button" onclick="addOutputVariable()">추가</button>
    </div>
</script>

<script type="text/html" data-help-name="task http">
    <p>HTTP 기반 Task를 수행하는 노드입니다.</p>
    <h3>설정</h3>
    <ul>
        <li><b>MDTPlatform Endpoint</b>: MDT Platform API 엔드포인트 URL (환경 변수 MDT_ENDPOINT 사용 가능)</li>
        <li><b>연산서버 Endpoint</b>: Task가 수행될 HTTP 서버의 endpoint (필수)</li>
        <li><b>연산 식별자</b>: 수행시킬 task의 연산 식별자 (필수)</li>
        <li><b>Poll</b>: Task 동작 점검 시간 간격 (기본값 1.0)</li>
        <li><b>Timeout</b>: Task 실행 제한 시간 (기본값 null)</li>
        <li><b>입력변수 목록</b>: (name, variable-spec, type) 리스트</li>
        <li><b>출력변수 목록</b>: (name, reference) 리스트</li>
        <li><b>Type</b>: reference, value, element 중 하나 선택 (입력변수만 해당)</li>
    </ul>
</script> 